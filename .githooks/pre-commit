#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

staged_files=()
while IFS= read -r -d '' f; do
  staged_files+=("$f")
done < <(git diff --cached --name-only -z --diff-filter=ACMR)

if [ "${#staged_files[@]}" -eq 0 ]; then
  exit 0
fi

is_fmt_file() {
  case "$1" in
    *.ts|*.tsx|*.js|*.jsx|*.cjs|*.mjs|*.cts|*.mts|*.json|*.jsonc|*.css) return 0 ;;
    *) return 1 ;;
  esac
}

is_lint_file() {
  case "$1" in
    *.ts|*.tsx|*.js|*.jsx|*.cjs|*.mjs|*.cts|*.mts) return 0 ;;
    *) return 1 ;;
  esac
}

fmt_paths=()
lint_paths=()
fmt_repo_paths=()

for f in "${staged_files[@]}"; do
  if [[ "$f" == backend/* ]] || [[ "$f" == frontend/* ]]; then
    if is_fmt_file "$f"; then
      fmt_paths+=("$f")
      fmt_repo_paths+=("$f")
    fi
    if is_lint_file "$f"; then
      lint_paths+=("$f")
    fi
  fi
done

# 1) Auto-fix formatting for staged files
if [ "${#fmt_paths[@]}" -gt 0 ]; then
  echo "[pre-commit] oxfmt"
  npx --no-install oxfmt --write --no-error-on-unmatched-pattern "${fmt_paths[@]}"
fi

# Re-stage any formatting changes
if [ "${#fmt_repo_paths[@]}" -gt 0 ]; then
  git add -- "${fmt_repo_paths[@]}"
fi

# 2) Verify lint for staged files
if [ "${#lint_paths[@]}" -gt 0 ]; then
  echo "[pre-commit] oxlint"
  npx --no-install oxlint "${lint_paths[@]}"
fi
